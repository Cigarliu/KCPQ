# KCPQ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²æŒ‡å—

æœ¬æ–‡æ¡£ä»¥ä»“åº“å†…çš„ä¸‰ä¸ªç”Ÿäº§é“¾è·¯ç»„ä»¶ä¸ºä¸»çº¿ï¼Œç»™å‡ºå¯ç›´æ¥è½åœ°çš„éƒ¨ç½²æ–¹å¼ï¼Œå¹¶ä¸å½“å‰ä»£ç å®ç°ä¿æŒä¸€è‡´ï¼š

1. **kcpq-server**ï¼ˆè¿œç¨‹ Linuxï¼‰ï¼šKCPQ æ¶ˆæ¯åˆ†å‘æœåŠ¡ç«¯
2. **h264-relay**ï¼ˆæœ¬åœ° Windows/Linuxï¼‰ï¼šæ¥æ”¶ UDP H.264 æµå¹¶å‘å¸ƒåˆ° KCPQ
3. **kcpq-to-nats**ï¼ˆæœ¬åœ° Windows/Linuxï¼‰ï¼šä» KCPQ è®¢é˜…å¹¶è½¬å‘åˆ° NATS

å¯¹åº”å…¥å£ï¼š`examples/server`ã€`examples/h264-relay`ã€`examples/kcpq-to-nats`

## 0. å¿…é¡»å…ˆå¯¹é½çš„äº‹å®ï¼ˆå¼ºåˆ¶åŠ å¯†ï¼‰

å½“å‰ä»£ç åº“å·²å¼ºåˆ¶å¯ç”¨ **AES-256 PSK**ï¼ˆKCP å±‚åŠ å¯†ï¼‰ï¼š

- æœåŠ¡ç«¯å¯åŠ¨å‰å¿…é¡»é…ç½® `KCPQ_AES256_KEY_HEX`ï¼ˆ64 ä¸ª hex å­—ç¬¦ï¼Œè§£ç ä¸º 32 å­—èŠ‚ï¼‰
- å®¢æˆ·ç«¯ä¹Ÿå¿…é¡»ä½¿ç”¨åŒä¸€æŠŠ keyï¼Œå¦åˆ™ä¼šå‡ºç°â€œçœ‹ä¼¼è¿ä¸Šï¼Œä½†è®¢é˜…/æ”¶å‘è¶…æ—¶â€çš„ç°è±¡

ç¤ºä¾‹ç¨‹åºä¼˜å…ˆä»é…ç½®æ–‡ä»¶è¯»å– `aes256_key_hex`ï¼Œä¹Ÿæ”¯æŒç”¨ç¯å¢ƒå˜é‡ `KCPQ_AES256_KEY_HEX` è¦†ç›–ï¼ˆæ¨èç”Ÿäº§æ³¨å…¥æ•æ„Ÿä¿¡æ¯ï¼‰ã€‚

## 1. ç½‘ç»œä¸ç«¯å£

- KCPQ æœåŠ¡ï¼šé»˜è®¤ `:4000/udp`ï¼ˆå¯ç”¨ `KCP_NATS_ADDR` ä¿®æ”¹ï¼‰
- h264-relay UDP è¾“å…¥ï¼šé»˜è®¤ `:22345/udp`ï¼ˆå¯ç”¨ `UDP_LISTEN` ä¿®æ”¹ï¼‰
- pprofï¼šç¤ºä¾‹ server é»˜è®¤ `localhost:6060/tcp`ï¼ˆåªç›‘å¬æœ¬æœºå›ç¯ï¼Œä¸å¯¹å…¬ç½‘å¼€æ”¾ï¼‰

## 2. å¯†é’¥å‡†å¤‡ï¼ˆAES-256 PSKï¼‰

ç”Ÿæˆéšæœº keyï¼ˆLinuxï¼‰ï¼š

```bash
openssl rand -hex 32
```

ç”Ÿæˆéšæœº keyï¼ˆPowerShellï¼‰ï¼š

```powershell
$bytes = New-Object byte[] 32
[System.Security.Cryptography.RandomNumberGenerator]::Create().GetBytes($bytes)
($bytes | ForEach-Object { $_.ToString('x2') }) -join ''
```

éƒ¨ç½²æ—¶ä»¥ç¯å¢ƒå˜é‡æ³¨å…¥ï¼ˆä¸è¦å†™æ­»åœ¨ä»£ç /ä»“åº“ï¼‰ï¼š

```bash
export KCPQ_AES256_KEY_HEX=<64-hex-chars>
```

## 3. éƒ¨ç½² kcpq-serverï¼ˆLinuxï¼‰

### 3.1 Windows â†’ Linux äº¤å‰ç¼–è¯‘ï¼ˆä¸ä»“åº“è„šæœ¬ä¸€è‡´ï¼‰

è„šæœ¬ä½ç½®ï¼š`examples/server/build-linux.ps1`

```powershell
cd E:\Code\KCP\KCPQ\examples\server
.\build-linux.ps1
```

è¾“å‡ºï¼š`kcpq-server-linux`

### 3.2 é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

server ç¤ºä¾‹é»˜è®¤ä¼šè¯»å–å½“å‰å·¥ä½œç›®å½•çš„ `config.yaml`ï¼Œä¹Ÿå¯æŒ‡å®šï¼š

```bash
./kcpq-server -config ./config.yaml
```

é…ç½®æ–‡ä»¶å­—æ®µï¼ˆè§ `examples/server/config.yaml`ï¼‰ï¼š

- `listen_addr`ï¼ˆé»˜è®¤ `:4000`ï¼‰
- `pprof_addr`ï¼ˆé»˜è®¤ `localhost:6060`ï¼‰
- `aes256_key_hex`ï¼ˆå¿…å¡«ï¼Œ64 hexï¼‰

ç¯å¢ƒå˜é‡è¦†ç›–ä¼˜å…ˆçº§ï¼ˆç”Ÿäº§æ¨èæ³¨å…¥æ•æ„Ÿé…ç½®ï¼‰ï¼š

- `KCP_NATS_ADDR` è¦†ç›– `listen_addr`
- `KCPQ_PPROF_ADDR` è¦†ç›– `pprof_addr`
- `KCPQ_AES256_KEY_HEX` è¦†ç›– `aes256_key_hex`

### 3.3 ä¸Šä¼ ä¸æ›´æ–°

åœ¨ Windowsï¼ˆGit Bashï¼‰ç”¨ scp ä¸Šä¼ ï¼ˆè·¯å¾„æŒ‰ä½ å®é™…ç›®å½•è°ƒæ•´ï¼‰ï¼š

```bash
scp E:/Code/KCP/KCPQ/examples/server/kcpq-server-linux root@<è¿œç¨‹æœåŠ¡å™¨IP>:/opt/kcpq/kcpq-server
```

åœ¨è¿œç¨‹ Linux ä¸Šå‡†å¤‡ç›®å½•ä¸æƒé™ï¼š

```bash
sudo mkdir -p /opt/kcpq
sudo chmod +x /opt/kcpq/kcpq-server
```

### 3.4 ä»¥ systemd æ‰˜ç®¡ï¼ˆæ¨èï¼‰

åˆ›å»ºç”¨æˆ·ï¼š

```bash
sudo useradd --system --no-create-home --shell /usr/sbin/nologin kcpq || true
```

åˆ›å»º `/etc/systemd/system/kcpq.service`ï¼š

```ini
[Unit]
Description=KCPQ Server
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=kcpq
Group=kcpq
WorkingDirectory=/opt/kcpq
Environment=KCP_NATS_ADDR=:4000
Environment=KCPQ_AES256_KEY_HEX=<64-hex-chars>
ExecStart=/opt/kcpq/kcpq-server
Restart=always
RestartSec=2
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/kcpq

[Install]
WantedBy=multi-user.target
```

åŠ è½½ä¸å¯åŠ¨ï¼š

```bash
sudo systemctl daemon-reload
sudo systemctl enable --now kcpq
sudo systemctl status kcpq --no-pager
```

æŸ¥çœ‹æ—¥å¿—ï¼š

```bash
journalctl -u kcpq -f
```

### 3.5 éªŒè¯æœåŠ¡ç«¯ç›‘å¬

```bash
ss -lunp | grep 4000
```

## 4. éƒ¨ç½² h264-relayï¼ˆWindows æœ¬åœ°ï¼‰

### 4.1 ç¼–è¯‘

```powershell
cd E:\Code\KCP\KCPQ\examples\h264-relay
go build -o h264-relay.exe .
```

### 4.2 é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

é»˜è®¤ä¼šè¯»å–å½“å‰ç›®å½•çš„ `config.yaml`ï¼Œä¹Ÿå¯æŒ‡å®šï¼š

```powershell
.\h264-relay.exe -config .\config.yaml
```

é…ç½®æ–‡ä»¶å­—æ®µï¼ˆè§ `examples/h264-relay/config.yaml`ï¼‰ï¼š

- `udp_listen`
- `kcpq_server`
- `subject`
- `aes256_key_hex`ï¼ˆå¿…å¡«ï¼Œ64 hexï¼‰
- `stats_interval`
- `buffer_size`
- `auto_reconnect`
- `reconnect_interval`

### 4.3 ç¯å¢ƒå˜é‡è¦†ç›–ï¼ˆç”Ÿäº§æ¨èï¼‰

ç¯å¢ƒå˜é‡å¯è¦†ç›–é…ç½®æ–‡ä»¶ï¼ˆæ•æ„Ÿä¿¡æ¯å»ºè®®èµ°ç¯å¢ƒå˜é‡ï¼‰ï¼š

- `KCPQ_AES256_KEY_HEX` è¦†ç›– `aes256_key_hex`
- `KCPQ_SERVER` è¦†ç›– `kcpq_server`
- `KCPQ_SUBJECT` è¦†ç›– `subject`
- `UDP_LISTEN` è¦†ç›– `udp_listen`

ç¤ºä¾‹ï¼ˆPowerShellï¼‰ï¼š

```powershell
$env:KCPQ_AES256_KEY_HEX = "<64-hex-chars>"
$env:KCPQ_SERVER = "<è¿œç¨‹æœåŠ¡å™¨IP>:4000"
$env:KCPQ_SUBJECT = "h264.stream"
$env:UDP_LISTEN = ":22345"
.\h264-relay.exe
```

åå°è¿è¡Œå¹¶è®°å½•æ—¥å¿—ï¼š

```powershell
Start-Process -FilePath ".\h264-relay.exe" -RedirectStandardOutput "h264-relay.log" -RedirectStandardError "h264-relay-error.log"
```

### 4.4 å…¸å‹éªŒè¯ç‚¹

- æ—¥å¿—å‡ºç° â€œConnected to KCPQ serverâ€
- UDP å£æ”¶åˆ°æ•°æ®åå¼€å§‹æŒç»­ â€œPublished frame â€¦â€
- æ¯ 10 ç§’è¾“å‡ºç»Ÿè®¡ï¼ˆfps/åå/é”™è¯¯æ•°ï¼‰

## 5. éƒ¨ç½² kcpq-to-natsï¼ˆWindows æœ¬åœ°ï¼‰

### 5.1 ç¼–è¯‘

```powershell
cd E:\Code\KCP\KCPQ\examples\kcpq-to-nats
go build -o kcpq-to-nats.exe .
```

### 5.2 é…ç½®æ–‡ä»¶ï¼ˆæ¨èï¼‰

é»˜è®¤ä¼šè¯»å–å½“å‰ç›®å½•çš„ `config.yaml`ï¼Œä¹Ÿå¯æŒ‡å®šï¼š

```powershell
.\kcpq-to-nats.exe -config .\config.yaml
```

é…ç½®æ–‡ä»¶å­—æ®µï¼ˆè§ `examples/kcpq-to-nats/config.yaml`ï¼‰ï¼š

- `kcpq_server`
- `kcpq_subject`
- `nats_server`
- `nats_subject`
- `aes256_key_hex`ï¼ˆå¿…å¡«ï¼Œ64 hexï¼‰
- `stats_interval`
- `auto_reconnect`
- `reconnect_interval`
- `use_channel_mode`

### 5.3 ç¯å¢ƒå˜é‡è¦†ç›–ï¼ˆç”Ÿäº§æ¨èï¼‰

ç¯å¢ƒå˜é‡å¯è¦†ç›–é…ç½®æ–‡ä»¶ï¼š

- `KCPQ_AES256_KEY_HEX` è¦†ç›– `aes256_key_hex`
- `KCPQ_SERVER` è¦†ç›– `kcpq_server`
- `KCPQ_SUBJECT` è¦†ç›– `kcpq_subject`
- `NATS_SERVER` è¦†ç›– `nats_server`
- `NATS_SUBJECT` è¦†ç›– `nats_subject`

ç¤ºä¾‹ï¼ˆPowerShellï¼‰ï¼š

```powershell
$env:KCPQ_AES256_KEY_HEX = "<64-hex-chars>"
$env:KCPQ_SERVER = "<è¿œç¨‹æœåŠ¡å™¨IP>:4000"
$env:KCPQ_SUBJECT = "h264.stream"
$env:NATS_SERVER = "nats://<your-nats-host>:4222"
$env:NATS_SUBJECT = "h264.stream"
.\kcpq-to-nats.exe
```

åå°è¿è¡Œå¹¶è®°å½•æ—¥å¿—ï¼š

```powershell
Start-Process -FilePath ".\kcpq-to-nats.exe" -RedirectStandardOutput "kcpq-to-nats.log" -RedirectStandardError "kcpq-to-nats-error.log"
```

### 5.4 å…¸å‹éªŒè¯ç‚¹

- æ—¥å¿—å‡ºç° â€œConnected to KCPQ / Connected to NATSâ€
- è®¢é˜…æˆåŠŸåæŒç»­ forward/ç»Ÿè®¡è¾“å‡º

## 6. ç«¯åˆ°ç«¯é“¾è·¯éªŒè¯ï¼ˆç”Ÿäº§æœ€å¸¸ç”¨ï¼‰

æ•°æ®æµå‘ï¼š

```
H.264 æº (UDP 22345)
    â†“
h264-relay (æœ¬åœ°)
    â†“ KCPQ over UDP (AES-256 PSK)
kcpq-server (è¿œç¨‹ :4000/udp)
    â†“ KCPQ è®¢é˜…
kcpq-to-nats (æœ¬åœ°)
    â†“ NATS
NATS Server
```

æ£€æŸ¥é¡ºåºï¼ˆä»æºå¤´åˆ°ä¸‹æ¸¸ï¼‰ï¼š

1) h264-relayï¼šç¡®è®¤æŒç»­æ”¶åˆ° UDP åŒ…ä¸”æŒç»­ publish  
2) kcpq-serverï¼šè¿æ¥æ•°/è®¢é˜…æ•°éšå®¢æˆ·ç«¯å˜åŒ–ï¼ˆç¤ºä¾‹ server æ¯ 5 ç§’æ‰“å° statsï¼‰  
3) kcpq-to-natsï¼šç¡®è®¤æŒç»­ forwardï¼Œä¸”é”™è¯¯ç‡å¯æ§  
4) NATSï¼šç”¨ä½ çš„æ¶ˆè´¹ç«¯è®¢é˜… `NATS_SUBJECT` éªŒè¯æ˜¯å¦æ”¶åˆ°æ•°æ®

## 7. æ•…éšœæ’æŸ¥ï¼ˆæŒ‰çœŸå®å¸¸è§é¡ºåºï¼‰

### 7.1 UDP 22345 ç«¯å£è¢«å ç”¨ï¼ˆh264-relay å¯åŠ¨å¤±è´¥ï¼‰

```powershell
netstat -ano | findstr :22345
taskkill /F /PID <PID>
```

### 7.2 æ— æ³•è¿æ¥è¿œç¨‹ kcpq-serverï¼ˆi/o timeoutï¼‰

æ£€æŸ¥æ¸…å•ï¼š

- è¿œç¨‹å®‰å…¨ç»„/é˜²ç«å¢™æ˜¯å¦æ”¾è¡Œ `udp/4000`
- è¿œç¨‹æœåŠ¡æ˜¯å¦å­˜æ´»ï¼š`systemctl status kcpq`
- è¿œç¨‹ç›‘å¬æ˜¯å¦å­˜åœ¨ï¼š`ss -lunp | grep 4000`

### 7.3 key ä¸ä¸€è‡´ï¼ˆæœ€å®¹æ˜“è¸©å‘ï¼‰

å…¸å‹è¡¨ç°ï¼š

- å®¢æˆ·ç«¯è¿›ç¨‹åœ¨è·‘ï¼Œä½†è®¢é˜…/æ”¶å‘è¶…æ—¶
- ä¸Šæ¸¸çœ‹èµ·æ¥â€œConnectedâ€ï¼Œä½†ä¸‹æ¸¸æ°¸è¿œæ”¶ä¸åˆ°

å¤„ç†ï¼š

- ç¡®è®¤ä¸‰è€…ï¼ˆserverã€h264-relayã€kcpq-to-natsï¼‰ä½¿ç”¨åŒä¸€ä»½ key
- ç¡®è®¤ hex é•¿åº¦ä¸º 64ï¼Œä¸”è§£ç ä¸º 32 bytes

### 7.4 NATS è¿æ¥å¤±è´¥

æ£€æŸ¥ï¼š

- `NATS_SERVER` åœ°å€æ˜¯å¦æ­£ç¡®ã€DNS æ˜¯å¦å¯è§£æ
- æœåŠ¡å™¨ç«¯å£ä¸é˜²ç«å¢™æ˜¯å¦å¼€æ”¾
- NATS æ˜¯å¦éœ€è¦é‰´æƒï¼ˆå½“å‰ç¤ºä¾‹ä½¿ç”¨æ— è´¦å·å¯†ç è¿æ¥ï¼‰

## 8. å®æˆ˜ç»éªŒè¡¥å……ï¼ˆåŸºäºçœŸå®éƒ¨ç½²æ¡ˆä¾‹ï¼‰

### 8.1 âš ï¸ ç¼–è¯‘éªŒè¯ï¼šè­¦æƒ•"æˆåŠŸ"çš„é”™è¯¯è¾“å‡º

**é—®é¢˜ç°è±¡ï¼š**
```powershell
PS E:\Code\KCP\KCPQ\examples\server> .\build-linux.ps1
# command-line-arguments
.\main.go:22:10: undefined: ConfigFile
.\main.go:34:18: undefined: LoadConfig
Build complete! Checking file type...
kcpq-server-linux: ELF 64-bit LSB executable...
```

**ä¸¥é‡æ€§ï¼š** è™½ç„¶æ˜¾ç¤º "Build complete"ï¼Œä½†ç”Ÿæˆçš„äºŒè¿›åˆ¶æ–‡ä»¶æœ‰ **ä¸¥é‡ BUG**ï¼Œä¼šå¯¼è‡´ï¼š
- KCP æ¡æ‰‹å®Œå…¨å¤±è´¥
- å®¢æˆ·ç«¯æ˜¾ç¤º "Connected" ä½†æœåŠ¡å™¨æ— ä»»ä½•è¿æ¥æ—¥å¿—
- UDP æ•°æ®åŒ…åˆ°è¾¾æœåŠ¡å™¨ä½†æ— æ³•å»ºç«‹ä¼šè¯

**éªŒè¯æ–¹æ³•ï¼š**
```bash
# æ£€æŸ¥ç¼–è¯‘è¾“å‡ºï¼Œç¡®ä¿æ²¡æœ‰ä»»ä½• undefined é”™è¯¯
go build -o kcpq-server-linux . 2>&1 | grep -i error

# éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶
file kcpq-server-linux
md5sum kcpq-server-linux
```

**æ­£ç¡®ç¼–è¯‘æ–¹å¼ï¼š**
```bash
# æ¨èï¼šæ‰‹åŠ¨ç¼–è¯‘å¹¶æ£€æŸ¥é”™è¯¯
GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o kcpq-server-linux .
echo $?  # å¿…é¡»è¾“å‡º 0

# æ£€æŸ¥æ–‡ä»¶å¤§å°ï¼ˆæ­£å¸¸ 8-9MBï¼Œæœ‰ bug å¯èƒ½ 10+MBï¼‰
ls -lh kcpq-server-linux
```

---

### 8.2 ğŸ” å¯†é’¥é…ç½®ä¸‰é‡éªŒè¯

**é—®é¢˜æ¡ˆä¾‹ï¼š** é…ç½®æ–‡ä»¶ä¸­çš„å¯†é’¥è¢«æ„å¤–è®¾ç½®ä¸ºå…¨é›¶ï¼š
```yaml
aes256_key_hex: "0000000000000000000000000000000000000000000000000000000000000000"
```

**åæœï¼š** 
- æœåŠ¡å™¨èƒ½å¯åŠ¨ä½†æ— æ³•æ¥å—ä»»ä½•è¿æ¥
- KCP åŠ å¯†æ¡æ‰‹å¤±è´¥ï¼ˆå¯†é’¥ä¸åŒ¹é…ï¼‰

**ä¸‰é‡éªŒè¯æ¸…å•ï¼š**

1. **é…ç½®æ–‡ä»¶æ£€æŸ¥ï¼š**
```bash
# æ£€æŸ¥å¯†é’¥æ˜¯å¦å…¨é›¶æˆ–è¿‡çŸ­
grep "aes256_key_hex" config.yaml

# éªŒè¯é•¿åº¦ï¼ˆå¿…é¡»æ˜¯ 64 ä¸ª hex å­—ç¬¦ï¼‰
grep "aes256_key_hex" config.yaml | awk '{print length($2)}'
```

2. **systemd æœåŠ¡éªŒè¯ï¼š**
```bash
# æŸ¥çœ‹æœåŠ¡é…ç½®ä¸­çš„å¯†é’¥
systemctl cat kcpq | grep "KCPQ_AES256_KEY_HEX"

# ç¡®ä¿å¯†é’¥å·²æ­£ç¡®æ³¨å…¥
systemctl show kcpq | grep Environment
```

3. **è¿è¡Œæ—¶éªŒè¯ï¼š**
```bash
# æŸ¥çœ‹æœåŠ¡å™¨æ—¥å¿—ï¼Œç¡®è®¤æ²¡æœ‰åŠ å¯†é”™è¯¯
journalctl -u kcpq | grep -i "error\|crypto\|aes"

# ä½¿ç”¨ tcpdump éªŒè¯ UDP æ•°æ®åŒ…ï¼ˆåº”è¯¥èƒ½çœ‹åˆ° KCP æ¡æ‰‹åŒ…ï¼‰
tcpdump -i any udp port 4000 -c 5
```

---

### 8.3 ğŸ” KCP æ¡æ‰‹å¤±è´¥æ’æŸ¥æµç¨‹

**å…¸å‹ç—‡çŠ¶ï¼š**
- å®¢æˆ·ç«¯æ—¥å¿—ï¼š`[OK] Connected to KCPQ server`
- æœåŠ¡å™¨æ—¥å¿—ï¼š`Connections: 0`ï¼ˆæ— ä»»ä½• "New connection" æ¶ˆæ¯ï¼‰
- tcpdump æ˜¾ç¤º UDP æ•°æ®åŒ…åˆ°è¾¾ä½†æ— ä¼šè¯å»ºç«‹

**æ’æŸ¥æ­¥éª¤ï¼š**

1. **éªŒè¯ç½‘ç»œå¯è¾¾æ€§ï¼š**
```bash
# åœ¨æœåŠ¡å™¨ä¸ŠæŠ“åŒ…
tcpdump -i any udp port 4000 -n -c 10

# åº”è¯¥çœ‹åˆ°ç±»ä¼¼è¾“å‡ºï¼š
# 05:18:17.960664 eth0 In IP 157.18.6.112.56366 > cigar.4000: UDP, length 59
```

2. **éªŒè¯æœåŠ¡å™¨äºŒè¿›åˆ¶ï¼š**
```bash
# æ£€æŸ¥æ–‡ä»¶ä¿®æ”¹æ—¶é—´
stat /opt/kcpq/kcpq-server | grep Modify

# è®¡ç®— MD5ï¼ˆç¡®ä¿ä¸æœ¬åœ°ç¼–è¯‘ç‰ˆæœ¬ä¸€è‡´ï¼‰
md5sum /opt/kcpq/kcpq-server

# å¯¹æ¯”æœ¬åœ°ç‰ˆæœ¬
md5sum kcpq-server-linux
```

3. **éªŒè¯å¯†é’¥ä¸€è‡´æ€§ï¼š**
```bash
# å®¢æˆ·ç«¯ä½¿ç”¨çš„å¯†é’¥
echo $KCPQ_AES256_KEY_HEX

# æœåŠ¡å™¨ä½¿ç”¨çš„å¯†é’¥
systemctl cat kcpq | grep KCPQ_AES256_KEY_HEX

# å¿…é¡»å®Œå…¨ä¸€è‡´ï¼ˆåŒ…æ‹¬å¤§å°å†™ï¼‰
```

4. **é‡æ–°ç¼–è¯‘å¹¶ä¸Šä¼ ï¼ˆå¦‚æœä¸Šè¿°éƒ½æ­£å¸¸ï¼‰ï¼š**
```bash
# æœ¬åœ°é‡æ–°ç¼–è¯‘
cd examples/server
GOOS=linux GOARCH=amd64 go build -ldflags="-s -w" -o kcpq-server-new .
md5sum kcpq-server-new

# å¤‡ä»½æ—§ç‰ˆæœ¬
ssh root@server "systemctl stop kcpq && mv /opt/kcpq/kcpq-server /opt/kcpq/kcpq-server.old"

# ä¸Šä¼ æ–°ç‰ˆæœ¬ï¼ˆä½¿ç”¨ SCP æˆ– SFTPï¼‰
scp kcpq-server-new root@server:/opt/kcpq/kcpq-server

# é‡å¯æœåŠ¡
ssh root@server "chmod +x /opt/kcpq/kcpq-server && systemctl start kcpq"

# éªŒè¯è¿æ¥æˆåŠŸ
ssh root@server "journalctl -u kcpq -n 10 | grep 'New connection'"
```

---

### 8.4 ğŸ“Š systemd æœåŠ¡é…ç½®ä¼˜åŒ–

**é—®é¢˜ï¼š** é»˜è®¤é…ç½®å¯èƒ½å¯¼è‡´æ—¥å¿—ä¸¢å¤±åˆ°æ§åˆ¶å°ã€‚

**ä¼˜åŒ–é…ç½®ï¼š**
```ini
[Unit]
Description=KCPQ Server
After=network-online.target
Wants=network-online.target

[Service]
Type=simple
User=kcpq
Group=kcpq
WorkingDirectory=/opt/kcpq

# å¯†é’¥é…ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰
Environment=KCP_NATS_ADDR=:4000
Environment=KCPQ_AES256_KEY_HEX=868af252ba94b53544998d998f359490ce536c258de7e29fe8c16b5ee7ffc700

ExecStart=/opt/kcpq/kcpq-server

# é‡å¯ç­–ç•¥
Restart=always
RestartSec=2
StartLimitInterval=60
StartLimitBurst=3

# å®‰å…¨åŠ å›º
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=strict
ProtectHome=true
ReadWritePaths=/opt/kcpq

# â­ æ—¥å¿—é…ç½®ï¼ˆé‡è¦ï¼‰
StandardOutput=journal
StandardError=journal
SyslogIdentifier=kcpq-server

[Install]
WantedBy=multi-user.target
```

**é‡å¯å¹¶éªŒè¯ï¼š**
```bash
systemctl daemon-reload
systemctl restart kcpq
journalctl -u kcpq -f  # åº”è¯¥çœ‹åˆ°å®Œæ•´æ—¥å¿—
```

---

### 8.5 ğŸš€ å®¢æˆ·ç«¯å¯åŠ¨æ–¹å¼å¯¹æ¯”

**âŒ ä¸æ¨èï¼šPowerShell Start-Process**
```powershell
# é—®é¢˜ï¼šæ—¥å¿—é‡å®šå‘åˆ°æ–‡ä»¶ï¼Œæ— æ³•å®æ—¶æŸ¥çœ‹
Start-Process -FilePath ".\h264-relay.exe" `
    -RedirectStandardOutput "h264-relay.log" `
    -RedirectStandardError "h264-relay-error.log"
```

**âœ… æ¨èï¼šBash åå°è¿è¡Œ**
```bash
# ä¼˜ç‚¹ï¼š
# 1. æ—¥å¿—ç›´æ¥è¾“å‡ºåˆ°æ–‡ä»¶ï¼Œå¯ç”¨ tail -f å®æ—¶æŸ¥çœ‹
# 2. è¿›ç¨‹ç®¡ç†æ›´ç®€å•ï¼ˆkillall, ps ç­‰ï¼‰
# 3. ç¯å¢ƒå˜é‡æ³¨å…¥æ›´å¯é 

cd examples/h264-relay
KCPQ_AES256_KEY_HEX=<your-key> ./h264-relay.exe -config config.yaml > h264-relay.log 2>&1 &

# å®æ—¶æŸ¥çœ‹æ—¥å¿—
tail -f h264-relay.log

# åœæ­¢è¿›ç¨‹
killall h264-relay
```

**Windows ç»ˆç«¯æ¨èï¼š**
```powershell
# ä½¿ç”¨ Git Bash æˆ– WSL
cd e:/Code/KCP/KCPQ/examples/h264-relay
$env:KCPQ_AES256_KEY_HEX="868af252ba94b53544998d998f359490ce536c258de7e29fe8c16b5ee7ffc700"
./h264-relay.exe -config config.yaml
```

---

### 8.6 ğŸ¯ å¿«é€ŸéªŒè¯æ¸…å•

éƒ¨ç½²å®Œæˆåï¼ŒæŒ‰ä»¥ä¸‹æ¸…å•é€é¡¹éªŒè¯ï¼š

**æœåŠ¡å™¨ç«¯ï¼š**
```bash
# 1. æœåŠ¡çŠ¶æ€
systemctl status kcpq --no-pager
# é¢„æœŸ: active (running)

# 2. ç«¯å£ç›‘å¬
ss -lunp | grep 4000
# é¢„æœŸ: UNCONN *:4000 users:(("kcpq-server",pid=...))

# 3. æ—¥å¿—æ— é”™è¯¯
journalctl -u kcpq -n 20 | grep -i error
# é¢„æœŸ: æ— è¾“å‡º

# 4. è¿æ¥ç»Ÿè®¡
journalctl -u kcpq -n 10 | grep "Server Stats"
# é¢„æœŸ: çœ‹åˆ° Connections: â‰¥ 0
```

**å®¢æˆ·ç«¯ h264-relayï¼š**
```bash
# 1. è¿›ç¨‹è¿è¡Œ
ps aux | grep h264-relay
# é¢„æœŸ: çœ‹åˆ°è¿›ç¨‹

# 2. æ—¥å¿—æ£€æŸ¥
tail -20 h264-relay.log | grep "Connected"
# é¢„æœŸ: [OK] Connected to KCPQ server

# 3. æ•°æ®å‘å¸ƒ
tail -10 h264-relay.log | grep "Published frame"
# é¢„æœŸ: æŒç»­è¾“å‡º Published frame #XXX

# 4. é”™è¯¯ç‡
tail -30 h264-relay.log | grep "Error Rate"
# é¢„æœŸ: Error Rate: < 10%
```

**å®¢æˆ·ç«¯ kcpq-to-natsï¼š**
```bash
# 1. è®¢é˜…æˆåŠŸ
tail -20 kcpq-to-nats.log | grep "subscribed"
# é¢„æœŸ: [OK] subscribed to h264.stream

# 2. è½¬å‘æ­£å¸¸
tail -10 kcpq-to-nats.log | grep "forwarded"
# é¢„æœŸ: æŒç»­è¾“å‡ºè½¬å‘ç»Ÿè®¡

# 3. æ— é”™è¯¯
tail -30 kcpq-to-nats.log | grep "Errors"
# é¢„æœŸ: Connection Errors: 0, Subscription Errors: 0
```

---

### 8.7 ğŸ’¡ å¸¸è§é”™è¯¯é€ŸæŸ¥è¡¨

| é”™è¯¯ä¿¡æ¯ | åŸå›  | è§£å†³æ–¹æ¡ˆ |
|---------|------|---------|
| `undefined: ConfigFile` | ç¼–è¯‘é”™è¯¯ä½†ç”ŸæˆäºŒè¿›åˆ¶ | é‡æ–°ç¼–è¯‘ï¼Œç¡®ä¿æ— é”™è¯¯è¾“å‡º |
| `Connections: 0` | KCP æ¡æ‰‹å¤±è´¥ | æ£€æŸ¥å¯†é’¥ä¸€è‡´æ€§ã€é‡æ–°ç¼–è¯‘æœåŠ¡å™¨ |
| `subscribe timeout` | è®¢é˜…è¶…æ—¶ | æ£€æŸ¥æœåŠ¡å™¨æ˜¯å¦æ¥å—è¿æ¥ã€éªŒè¯å¯†é’¥ |
| `io: read/write on closed pipe` | è¿æ¥æ–­å¼€ | æ£€æŸ¥ç½‘ç»œç¨³å®šæ€§ã€å¯ç”¨è‡ªåŠ¨é‡è¿ |
| `bind: address already in use` | ç«¯å£è¢«å ç”¨ | æ€æ­»æ—§è¿›ç¨‹æˆ–æ›´æ¢ç«¯å£ |
| `failed to listen: listen udp` | é˜²ç«å¢™æˆ–æƒé™é—®é¢˜ | æ£€æŸ¥é˜²ç«å¢™ã€ä½¿ç”¨ sudo è¿è¡Œ |
| `Error Rate: > 50%` | ç½‘ç»œæˆ–æœåŠ¡å™¨é—®é¢˜ | æ£€æŸ¥ç½‘ç»œè´¨é‡ã€éªŒè¯æœåŠ¡å™¨æ€§èƒ½ |

---

### 8.8 ğŸ“ ç´§æ€¥æ•‘æ´å‘½ä»¤

**ä¸€é”®é‡å¯æ•´ä¸ªé“¾è·¯ï¼ˆæœåŠ¡å™¨ï¼‰ï¼š**
```bash
ssh root@server << 'EOF'
systemctl restart kcpq
sleep 3
journalctl -u kcpq -n 10 --no-pager
ss -lunp | grep 4000
EOF
# éªŒè¯è¿æ¥æˆåŠŸ
journalctl -u kcpq -n 10 | grep 'New connection'
```

**ä¸€é”®é‡å¯å®¢æˆ·ç«¯ï¼ˆæœ¬åœ°ï¼‰ï¼š**
```bash
# åœæ­¢æ‰€æœ‰
killall -9 h264-relay kcpq-to-nats 2>/dev/null
sleep 2

# å¯åŠ¨ h264-relay
cd e:/Code/KCP/KCPQ/examples/h264-relay
KCPQ_AES256_KEY_HEX=868af252ba94b53544998d998f359490ce536c258de7e29fe8c16b5ee7ffc700 \
./h264-relay.exe -config config.yaml > h264-relay.log 2>&1 &

# å¯åŠ¨ kcpq-to-nats
cd ../kcpq-to-nats
KCPQ_AES256_KEY_HEX=868af252ba94b53544998d998f359490ce536c258de7e29fe8c16b5ee7ffc700 \
./kcpq-to-nats.exe -config config.yaml > kcpq-to-nats.log 2>&1 &

# éªŒè¯
sleep 5
ps aux | grep -E "h264-relay|kcpq-to-nats" | grep -v grep
```

**å…¨é“¾è·¯å¥åº·æ£€æŸ¥ï¼š**
```bash
# æœåŠ¡å™¨çŠ¶æ€
echo "=== Server Status ==="
ssh root@server "journalctl -u kcpq -n 5 | grep Stats"

# h264-relay çŠ¶æ€
echo "=== h264-relay ==="
tail -5 e:/Code/KCP/KCPQ/examples/h264-relay/h264-relay.log | grep -E "Connected|Published|fps"

# kcpq-to-nats çŠ¶æ€
echo "=== kcpq-to-nats ==="
tail -5 e:/Code/KCP/KCPQ/examples/kcpq-to-nats/kcpq-to-nats.log | grep -E "subscribed|forwarded|Errors"
```

---

## 9. æ€»ç»“ä¸æœ€ä½³å®è·µ

### âœ… éƒ¨ç½²å‰å¿…åš
1. ç”Ÿæˆå¹¶ä¿å­˜ AES-256 å¯†é’¥ï¼ˆ64 hex å­—ç¬¦ï¼‰
2. æ‰‹åŠ¨ç¼–è¯‘éªŒè¯ï¼ˆç¡®ä¿æ—  undefined é”™è¯¯ï¼‰
3. æ£€æŸ¥é…ç½®æ–‡ä»¶å¯†é’¥ï¼ˆä¸èƒ½å…¨é›¶æˆ–è¿‡çŸ­ï¼‰
4. å‡†å¤‡ systemd æœåŠ¡æ–‡ä»¶ï¼ˆä¼˜å…ˆä½¿ç”¨ç¯å¢ƒå˜é‡ï¼‰

### âœ… éƒ¨ç½²åå¿…æŸ¥
1. æœåŠ¡å™¨æ—¥å¿—æœ‰ "New connection" æ¶ˆæ¯
2. å®¢æˆ·ç«¯ "Connected" åèƒ½æ­£å¸¸è®¢é˜…
3. æ•°æ®æµèƒ½ç«¯åˆ°ç«¯è½¬å‘ï¼ˆæ— å¤§é‡é”™è¯¯ï¼‰
4. é”™è¯¯ç‡æ§åˆ¶åœ¨ < 10%

### âš ï¸ é¿å…çš„å‘
- âŒ å¿½è§†ç¼–è¯‘é”™è¯¯ï¼ˆundefined ä¹Ÿè¦ä¿®å¤ï¼‰
- âŒ ä½¿ç”¨å…¨é›¶æˆ–çŸ­å¯†é’¥
- âŒ ä¾èµ–é…ç½®æ–‡ä»¶è€Œä¸ç”¨ç¯å¢ƒå˜é‡
- âŒ ä¸éªŒè¯äºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆMD5ã€å¤§å°ï¼‰
- âŒ ç”¨ PowerShell Start-Process è€Œé Bash åå°
- âŒ ä¸æ£€æŸ¥æœåŠ¡å™¨æ—¥å¿—å°±è®¤ä¸ºéƒ¨ç½²æˆåŠŸ

### ğŸ¯ æˆåŠŸæ ‡å¿—
```
æœåŠ¡å™¨: Connections: 2, Subjects: 1
h264-relay: Published frame #1000+
kcpq-to-nats: [OK] First frame forwarded
é”™è¯¯ç‡: < 5%
```

---

**æ–‡æ¡£ç‰ˆæœ¬:** v2.1  
**æœ€åæ›´æ–°:** 2026-01-29  
**åŸºäºæ¡ˆä¾‹:** çœŸå®ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²ç»éªŒï¼ˆKCPQ v2.0ï¼‰
